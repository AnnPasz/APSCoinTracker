<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APS Symulator Cen</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%239b59b6'/%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1d1d1f;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #1d1d1f;
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4ecdc4;
        }
        
        small {
            display: block;
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .rate-display {
            background: rgba(78, 205, 196, 0.1);
            padding: 16px;
            border-radius: 10px;
            border-left: 3px solid #4ecdc4;
            margin-bottom: 20px;
        }
        
        .rate-display .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .rate-display .value {
            font-size: 22px;
            font-weight: 700;
            color: #1d1d1f;
        }
        
        .rate-display .subvalue {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }
        
        .rate-display .subvalue span {
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3);
            margin-bottom: 20px;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3);
            margin-top: 16px;
        }
        
        .btn-refresh {
            background: rgba(78, 205, 196, 0.2);
            color: #44a08d;
            border: 2px solid #4ecdc4;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 12px;
        }
        
        .result-box {
            background: rgba(155, 89, 182, 0.1);
            padding: 16px;
            border-radius: 10px;
            border-left: 3px solid #9b59b6;
            margin-bottom: 12px;
        }
        
        .result-box.green {
            background: rgba(78, 205, 196, 0.1);
            border-left-color: #4ecdc4;
        }
        
        .result-box.gradient {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            padding: 20px;
            text-align: center;
        }
        
        .result-box .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .result-box.gradient .label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .result-box .value {
            font-size: 20px;
            font-weight: 700;
            color: #1d1d1f;
        }
        
        .result-box.gradient .value {
            font-size: 32px;
            color: white;
        }
        
        .target-price-box {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .target-price-box .label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 4px;
        }
        
        .target-price-box .value {
            font-size: 28px;
            font-weight: 700;
            color: white;
        }
        
        .target-price-box .formula {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }
        
        .target-price-box.blue {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        
        .target-price-box.orange {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        }
        
        .target-price-box.teal {
            background: linear-gradient(135deg, #16a085 0%, #138f77 100%);
        }
        
        .target-price-box.red {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }
        
        .target-price-box.purple {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
        }
        
        .hidden {
            display: none !important;
        }
        
        h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #1d1d1f;
        }
        
        h4 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #1d1d1f;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">Halko Mio ‚ù§Ô∏è</div>
            <h1>üßÆ Symulator Cen</h1>
            <p>Oblicz warto≈õƒá monety na podstawie cen metali</p>
            
            <button id="oneBidModeToggle" class="btn" style="margin-top: 16px; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; padding: 12px 24px; box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3);">
                üî® Tryb OneBid
            </button>
        </div>

        <div class="card">
            <h3 id="calculatorTitle">Kalkulator</h3>
            
            <!-- OneBid Fee Input (hidden by default) -->
            <div id="oneBidFeeSection" class="form-group hidden">
                <label for="auctionFee">Op≈Çata aukcyjna (%):</label>
                <div style="position: relative;">
                    <input type="text" inputmode="decimal" id="auctionFee" placeholder="np. 12 lub 20" style="padding-right: 40px;" value="12">
                    <button onclick="document.getElementById('auctionFee').value=''; document.getElementById('auctionFee').focus();" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #e0e0e0; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 18px; color: #666; display: flex; align-items: center; justify-content: center; padding: 0;">√ó</button>
                </div>
                <small>Standardowa op≈Çata OneBid: 12% lub 20%</small>
            </div>
            
            <div class="form-group">
                <label for="metalType">Rodzaj metalu:</label>
                <select id="metalType">
                    <option value="AG">Srebro (AG)</option>
                    <option value="AU">Z≈Çoto (AU)</option>
                </select>
            </div>

            <div class="rate-display">
                <div class="label">Obecny kurs</div>
                <div class="value" id="currentRate">≈Åadowanie...</div>
                <div class="subvalue">Za gram: <span id="currentRatePerGram">-</span></div>
            </div>

            <div class="form-group">
                <label for="purity">Pr√≥ba (‚Ä∞):</label>
                <div style="position: relative;">
                    <input type="text" inputmode="numeric" pattern="[0-9]*" id="purity" placeholder="np. 925" min="0" max="1000" style="padding-right: 40px;">
                    <button onclick="document.getElementById('purity').value=''; document.getElementById('purity').focus();" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #e0e0e0; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 18px; color: #666; display: flex; align-items: center; justify-content: center; padding: 0;">√ó</button>
                </div>
                <small>900 = 90%, 925 = 92,5%</small>
            </div>

            <div class="form-group">
                <label for="weight">Waga (gramy):</label>
                <div style="position: relative;">
                    <input type="text" inputmode="decimal" id="weight" placeholder="np. 31.1" style="padding-right: 40px;">
                    <button onclick="document.getElementById('weight').value=''; document.getElementById('weight').focus();" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #e0e0e0; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 18px; color: #666; display: flex; align-items: center; justify-content: center; padding: 0;">√ó</button>
                </div>
            </div>

            <button class="btn btn-primary" id="calculateBtn">üßÆ Oblicz warto≈õƒá</button>
            
            <button class="btn btn-refresh" id="refreshRatesBtn">üîÑ Od≈õwie≈º kursy</button>
        </div>

        <div class="card hidden" id="resultCard">
            <h4>Wynik</h4>
            
            <div class="result-box">
                <div class="label">Czysty metal</div>
                <div class="value" id="pureWeight">-</div>
            </div>
            
            <div class="result-box green">
                <div class="label">Warto≈õƒá USD</div>
                <div class="value" id="valueUSD">-</div>
            </div>

            <div class="result-box gradient">
                <div class="label">Warto≈õƒá w PLN</div>
                <div class="value" id="valuePLN">-</div>
            </div>

            <button class="btn btn-secondary" id="targetPriceBtn">üéØ Cena docelowa</button>
        </div>
        
        <!-- OneBid Result Card -->
        <div class="card hidden" id="oneBidResultCard">
            <h4>Wynik OneBid</h4>
            
            <div class="result-box">
                <div class="label">Czysty metal</div>
                <div class="value" id="oneBidPureWeight">-</div>
            </div>
            
            <div style="background: rgba(155, 89, 182, 0.1); padding: 16px; border-radius: 10px; border-left: 3px solid #9b59b6; margin-bottom: 12px;">
                <div style="font-size: 12px; color: #666; margin-bottom: 8px;">Warto≈õƒá metalu</div>
                <div style="font-size: 16px; font-weight: 600; color: #1d1d1f; margin-bottom: 4px;">PLN: <span id="oneBidValuePLN">-</span></div>
                <div style="font-size: 16px; font-weight: 600; color: #1d1d1f; margin-bottom: 4px;">EUR: <span id="oneBidValueEUR">-</span></div>
                <div style="font-size: 16px; font-weight: 600; color: #1d1d1f;">USD: <span id="oneBidValueUSD">-</span></div>
            </div>
            
            <div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 6px;">üéØ Maksymalna stawka (po op≈Çacie <span id="feePercentDisplay">-</span>%)</div>
                <div style="font-size: 14px; font-weight: 600; color: white; margin-top: 12px;">PLN: <span id="oneBidTargetPLN" style="font-size: 24px; display: block; margin-top: 4px;">-</span></div>
                <div style="font-size: 14px; font-weight: 600; color: white; margin-top: 8px;">EUR: <span id="oneBidTargetEUR" style="font-size: 24px; display: block; margin-top: 4px;">-</span></div>
                <div style="font-size: 14px; font-weight: 600; color: white; margin-top: 8px;">USD: <span id="oneBidTargetUSD" style="font-size: 24px; display: block; margin-top: 4px;">-</span></div>
            </div>
        </div>

        <div class="card hidden" id="targetPriceCard">
            <h4>Ceny docelowe na Allegro</h4>
            
            <div class="target-price-box">
                <div class="label">Cena bazowa</div>
                <div class="value" id="targetPrice">-</div>
                <div class="formula">X = 10000 √ó (K + 11,49) √∑ 9631</div>
            </div>

            <div class="target-price-box blue">
                <div class="label">+10% mar≈ºa</div>
                <div class="value" id="targetPrice10">-</div>
                <div class="formula">X = 10000 √ó (1,1K + 11,49) √∑ 9631</div>
            </div>

            <div class="target-price-box orange">
                <div class="label">+20% mar≈ºa</div>
                <div class="value" id="targetPrice20">-</div>
                <div class="formula">X = 10000 √ó (1,2K + 11,49) √∑ 9631</div>
            </div>

            <div class="target-price-box teal">
                <div class="label">+30% mar≈ºa</div>
                <div class="value" id="targetPrice30">-</div>
                <div class="formula">X = 10000 √ó (1,3K + 11,49) √∑ 9631</div>
            </div>

            <div class="target-price-box red">
                <div class="label">+40% mar≈ºa</div>
                <div class="value" id="targetPrice40">-</div>
                <div class="formula">X = 10000 √ó (1,4K + 11,49) √∑ 9631</div>
            </div>

            <div class="target-price-box purple">
                <div class="label">+50% mar≈ºa</div>
                <div class="value" id="targetPrice50">-</div>
                <div class="formula">X = 10000 √ó (1,5K + 11,49) √∑ 9631</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let metalRatesUSD = { AU: null, AG: null };
        let exchangeRatesPLN = null;
        let lastCalculatedValuePLN = 0;
        let isOneBidMode = false; // OneBid mode toggle state

        // Helper functions
        const $ = (s) => document.querySelector(s);
        
        function convertUSDToPLN(amount) {
            if (!exchangeRatesPLN || !exchangeRatesPLN.USD) return amount;
            return amount / exchangeRatesPLN.USD;
        }
        
        function convertPLNToEUR(amountPLN) {
            if (!exchangeRatesPLN || !exchangeRatesPLN.EUR) return 0;
            return amountPLN / exchangeRatesPLN.EUR;
        }
        
        function convertPLNToUSD(amountPLN) {
            if (!exchangeRatesPLN || !exchangeRatesPLN.USD) return 0;
            return amountPLN / exchangeRatesPLN.USD;
        }

        // Fetch rates from APIs
        async function fetchRates() {
            const attempts = [
                async () => {
                    const r = await fetch('https://api.metals.live/v1/spot');
                    return r.ok ? await r.json() : null;
                },
                async () => {
                    const r = await fetch('https://data-asg.goldprice.org/dbXRates/USD');
                    return r.ok ? await r.json() : null;
                }
            ];
            
            for (const fn of attempts) {
                try {
                    const data = await fn();
                    if (!data) continue;
                    
                    if (Array.isArray(data)) {
                        for (const it of data) {
                            if (!it) continue;
                            if (it.metal && it.price) {
                                const m = (it.metal || '').toLowerCase();
                                if (m.includes('gold')) metalRatesUSD.AU = parseFloat(it.price) || metalRatesUSD.AU;
                                if (m.includes('silver')) metalRatesUSD.AG = parseFloat(it.price) || metalRatesUSD.AG;
                            } else {
                                if (it.gold) metalRatesUSD.AU = metalRatesUSD.AU || parseFloat(it.gold);
                                if (it.silver) metalRatesUSD.AG = metalRatesUSD.AG || parseFloat(it.silver);
                            }
                        }
                    } else if (typeof data === 'object') {
                        if (data.items && Array.isArray(data.items) && data.items.length) {
                            const item = data.items[0];
                            if (item.xauPrice) metalRatesUSD.AU = metalRatesUSD.AU || parseFloat(item.xauPrice);
                            if (item.xagPrice) metalRatesUSD.AG = metalRatesUSD.AG || parseFloat(item.xagPrice);
                        } else {
                            if (data.gold) metalRatesUSD.AU = metalRatesUSD.AU || parseFloat(data.gold);
                            if (data.silver) metalRatesUSD.AG = metalRatesUSD.AG || parseFloat(data.silver);
                        }
                    }
                    
                    if (metalRatesUSD.AU && metalRatesUSD.AG) break;
                } catch (err) {
                    console.warn('Metal rate fetch failed', err);
                }
            }
            
            // Fetch exchange rates
            let fxOk = false;
            try {
                const r = await fetch('https://api.exchangerate.host/latest?base=PLN');
                if (r.ok) {
                    const j = await r.json();
                    if (j && j.rates) {
                        exchangeRatesPLN = j.rates;
                        fxOk = true;
                    }
                }
            } catch (e) {
                console.warn('FX fetch (base=PLN) failed', e);
            }
            
            if (!fxOk) {
                try {
                    const r = await fetch('https://api.exchangerate.host/latest');
                    if (r.ok) {
                        const j = await r.json();
                        if (j && j.rates && j.rates.PLN) {
                            exchangeRatesPLN = {};
                            Object.keys(j.rates).forEach(c => exchangeRatesPLN[c] = j.rates[c] / j.rates.PLN);
                            fxOk = true;
                        }
                    }
                } catch (e) {
                    console.warn('FX fetch (convert) failed', e);
                }
            }
            
            if (!fxOk) {
                try {
                    const r = await fetch('https://open.er-api.com/v6/latest/PLN');
                    if (r.ok) {
                        const j = await r.json();
                        if (j && j.rates) {
                            exchangeRatesPLN = j.rates;
                            fxOk = true;
                        }
                    }
                } catch (e) {
                    console.warn('FX fetch (open.er-api) failed', e);
                }
            }
            
            console.log('Metal rates:', metalRatesUSD);
            console.log('Exchange rates:', exchangeRatesPLN);
            updateRateDisplay();
        }

        function updateRateDisplay() {
            const metal = $('#metalType').value || 'AG';
            const rate = metal === 'AU' ? metalRatesUSD.AU : metalRatesUSD.AG;
            
            console.log('Updating rate display - metal:', metal, 'rate:', rate);
            
            if (rate) {
                const ratePerGram = rate / 31.1034768;
                $('#currentRate').textContent = '$' + rate.toFixed(2) + ' /oz';
                $('#currentRatePerGram').textContent = '$' + ratePerGram.toFixed(2) + ' /g';
            } else {
                $('#currentRate').textContent = 'Kurs niedostƒôpny';
                $('#currentRatePerGram').textContent = '-';
            }
        }

        function calculateValue() {
            if (isOneBidMode) {
                calculateOneBid();
                return;
            }
            
            const metal = $('#metalType').value || 'AG';
            let purity = parseFloat(($('#purity').value || '').replace(',', '.')) || 0;
            const weight = parseFloat(($('#weight').value || '').replace(',', '.')) || 0;
            
            // Validate purity range
            if (purity > 1000) {
                alert('‚ö†Ô∏è Pr√≥ba nie mo≈ºe byƒá wiƒôksza ni≈º 1000‚Ä∞');
                return;
            }
            
            if (!purity || !weight) {
                alert('‚ö†Ô∏è Proszƒô wprowadziƒá pr√≥bƒô i wagƒô');
                return;
            }
            
            const rate = metal === 'AU' ? metalRatesUSD.AU : metalRatesUSD.AG;
            if (!rate) {
                alert('‚ö†Ô∏è Kurs metalu niedostƒôpny. Proszƒô od≈õwie≈ºyƒá kursy.');
                return;
            }
            
            const purityDecimal = purity / 1000;
            const pureWeight = weight * purityDecimal;
            const ratePerGram = rate / 31.1034768;
            const valueUSD = pureWeight * ratePerGram;
            const valuePLN = convertUSDToPLN(valueUSD);
            
            lastCalculatedValuePLN = valuePLN;
            
            $('#pureWeight').textContent = pureWeight.toFixed(2) + ' g';
            $('#valueUSD').textContent = '$' + valueUSD.toFixed(2);
            $('#valuePLN').textContent = valuePLN.toFixed(2) + ' PLN';
            
            $('#resultCard').classList.remove('hidden');
            $('#oneBidResultCard').classList.add('hidden');
            $('#targetPriceCard').classList.add('hidden');
            
            // Scroll to result
            setTimeout(() => {
                $('#resultCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
        
        function calculateOneBid() {
            const metal = $('#metalType').value || 'AG';
            let purity = parseFloat(($('#purity').value || '').replace(',', '.')) || 0;
            const weight = parseFloat(($('#weight').value || '').replace(',', '.')) || 0;
            const auctionFee = parseFloat(($('#auctionFee').value || '').replace(',', '.')) || 0;
            
            // Validate purity range
            if (purity > 1000) {
                alert('‚ö†Ô∏è Pr√≥ba nie mo≈ºe byƒá wiƒôksza ni≈º 1000‚Ä∞');
                return;
            }
            
            if (!purity || !weight || !auctionFee) {
                alert('‚ö†Ô∏è Proszƒô wprowadziƒá pr√≥bƒô, wagƒô i op≈Çatƒô aukcyjnƒÖ');
                return;
            }
            
            const rate = metal === 'AU' ? metalRatesUSD.AU : metalRatesUSD.AG;
            if (!rate) {
                alert('‚ö†Ô∏è Kurs metalu niedostƒôpny. Proszƒô od≈õwie≈ºyƒá kursy.');
                return;
            }
            
            // Calculate metal value
            const purityDecimal = purity / 1000;
            const pureWeight = weight * purityDecimal;
            const ratePerGram = rate / 31.1034768;
            const valueUSD = pureWeight * ratePerGram;
            const valuePLN = convertUSDToPLN(valueUSD);
            const valueEUR = convertPLNToEUR(valuePLN);
            
            // Calculate target bid: divide by (1 + fee%) to get the amount to bid
            // Example: if metal value is 100 PLN and fee is 12%, bid = 100 / 1.12 = 89.29
            // Then: 89.29 + (89.29 * 0.12) = 100 PLN total
            const feeDivisor = 1 + (auctionFee / 100);
            const targetBidPLN = valuePLN / feeDivisor;
            const targetBidEUR = valueEUR / feeDivisor;
            const targetBidUSD = valueUSD / feeDivisor;
            
            // Update display
            $('#oneBidPureWeight').textContent = pureWeight.toFixed(2) + ' g';
            $('#oneBidValuePLN').textContent = valuePLN.toFixed(2);
            $('#oneBidValueEUR').textContent = valueEUR.toFixed(2);
            $('#oneBidValueUSD').textContent = '$' + valueUSD.toFixed(2);
            
            $('#feePercentDisplay').textContent = auctionFee.toFixed(0);
            $('#oneBidTargetPLN').textContent = targetBidPLN.toFixed(2) + ' PLN';
            $('#oneBidTargetEUR').textContent = targetBidEUR.toFixed(2) + ' ‚Ç¨';
            $('#oneBidTargetUSD').textContent = '$' + targetBidUSD.toFixed(2);
            
            $('#oneBidResultCard').classList.remove('hidden');
            $('#resultCard').classList.add('hidden');
            $('#targetPriceCard').classList.add('hidden');
            
            // Scroll to result
            setTimeout(() => {
                $('#oneBidResultCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function calculateTargetPrice() {
            if (!lastCalculatedValuePLN) {
                alert('‚ö†Ô∏è Proszƒô najpierw obliczyƒá warto≈õƒá monety');
                return;
            }
            
            const K = lastCalculatedValuePLN; // Base coin value
            const T = 11.49; // Transport fee
            
            // Base price: X = 10000 * (K + T) / 9631
            const targetPrice = (10000 * (K + T)) / 9631;
            
            // +10% margin: X = 10000 * (1.1*K + T) / 9631
            const targetPrice10 = (10000 * (1.1 * K + T)) / 9631;
            
            // +20% margin: X = 10000 * (1.2*K + T) / 9631
            const targetPrice20 = (10000 * (1.2 * K + T)) / 9631;
            
            // +30% margin: X = 10000 * (1.3*K + T) / 9631
            const targetPrice30 = (10000 * (1.3 * K + T)) / 9631;
            
            // +40% margin: X = 10000 * (1.4*K + T) / 9631
            const targetPrice40 = (10000 * (1.4 * K + T)) / 9631;
            
            // +50% margin: X = 10000 * (1.5*K + T) / 9631
            const targetPrice50 = (10000 * (1.5 * K + T)) / 9631;
            
            $('#targetPrice').textContent = targetPrice.toFixed(2) + ' PLN';
            $('#targetPrice10').textContent = targetPrice10.toFixed(2) + ' PLN';
            $('#targetPrice20').textContent = targetPrice20.toFixed(2) + ' PLN';
            $('#targetPrice30').textContent = targetPrice30.toFixed(2) + ' PLN';
            $('#targetPrice40').textContent = targetPrice40.toFixed(2) + ' PLN';
            $('#targetPrice50').textContent = targetPrice50.toFixed(2) + ' PLN';
            
            $('#targetPriceCard').classList.remove('hidden');
            
            // Scroll to target price result
            setTimeout(() => {
                $('#targetPriceCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        // Event listeners
        $('#metalType').addEventListener('change', updateRateDisplay);
        $('#calculateBtn').addEventListener('click', calculateValue);
        $('#targetPriceBtn').addEventListener('click', calculateTargetPrice);
        
        // OneBid mode toggle
        $('#oneBidModeToggle').addEventListener('click', function() {
            isOneBidMode = !isOneBidMode;
            
            if (isOneBidMode) {
                // Switch to OneBid mode
                this.textContent = 'üî® Tryb OneBid: W≈ÅƒÑCZONY';
                this.style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
                $('#calculatorTitle').textContent = 'Kalkulator OneBid';
                $('#oneBidFeeSection').classList.remove('hidden');
                $('#targetPriceBtn').style.display = 'none';
                
                // Hide normal result card if visible
                $('#resultCard').classList.add('hidden');
                $('#targetPriceCard').classList.add('hidden');
            } else {
                // Switch to normal mode
                this.textContent = 'üî® Tryb OneBid';
                this.style.background = 'linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%)';
                $('#calculatorTitle').textContent = 'Symulator ceny';
                $('#oneBidFeeSection').classList.add('hidden');
                $('#targetPriceBtn').style.display = '';
                
                // Hide OneBid result card if visible
                $('#oneBidResultCard').classList.add('hidden');
            }
        });
        
        $('#refreshRatesBtn').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'üîÑ Od≈õwie≈ºanie...';
            try {
                await fetchRates();
                btn.textContent = '‚úì Zaktualizowano';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Od≈õwie≈º kursy';
                    btn.disabled = false;
                }, 1000);
            } catch (err) {
                alert('‚ùå Nie uda≈Ço siƒô od≈õwie≈ºyƒá kurs√≥w');
                btn.disabled = false;
                btn.textContent = 'üîÑ Od≈õwie≈º kursy';
            }
        });

        // Initialize
        fetchRates();
    </script>
</body>
</html>
